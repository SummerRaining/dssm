

<div align = 'center'><font size = 70>AB测试和假设检验</font></div>

# 背景

​        推荐算法中开发出新的模型，需要线上AB测试和老模型对比，只有当新模型显著优与老模型时才能上线。而如何说明新模型是__显著__优于老模型呢，这里就需要做假设检验了。

​        我们以点击率为例说明该问题：

​        【点击率场景】最近模型团队新开发新模型模型，为了验证新模型效果，将人群随机分配进行AB测试，实验组A使用新模型，对照组B使用旧模型。观察了一段时间的结果后，得到如下观测结果：实验组A样本量10000人，点击量1000人；对照组B样本量10000人，点击量800人。是否能说明在提升点击率上新模型效果优于旧模型？



# 假设检验

考虑上面的例子，由于__是否点击__是0-1值，服从二项分布。因此我们假定A组中的用户$X_a\sim B(n_a,p_a)$。其中$n_a$就为A组的样本量，$p_a$为A中的点击率。同理，假定B组中的用户$X_b\sim B(n_b,p_b)$。

构建统计量，简单介绍中心极限定理：

​          【中心极限定理】设随机变量$X_1,X_2,…,X_n$独立同分布，并具有有限的期望和方差：$E(X_i) = \mu,var(X_i) = \sigma^2$. 则n比较大时，$X_1,X_2,…,X_n$的均值近似服从正态分布：
$$
\frac{1}{n}\sum_{i=1}^{n}X_i \sim N(\mu,\frac{\sigma^2}{n})
$$
根据中心极限定理可知：A组和B组的平均值分别服从正态分布如下
$$
\bar X_a = \frac{1}{n_a} \sum_{i=1}^{n_a}X_a^i \sim N(p_a,\frac{p_a(1-p_a)}{n_a}) \\
\bar X_b = \frac{1}{n_b} \sum_{i=1}^{n_b}X_b^i \sim N(p_b,\frac{p_b(1-p_b)}{n_b})
$$
根据正态分布的性质，$\bar X_a - \bar X_b$依然服从正态分布：
 
$$
\bar X_a - \bar X_b \sim N(p_a-p_b,\frac{p_a(1-p_a)}{n_a}+\frac{p_b(1-p_b)}{n_b})
$$
对$\bar X_a-\bar X_b$减去均值，除以标准差得到：
$$
\large \frac{(\bar X_a - \bar X_b)-(p_a-p_b)}{\sqrt{\frac{p_a(1-p_a)}{n_a}+\frac{p_b(1-p_b)}{n_b}}} 
\sim N(0,1)
$$
构建原假设和备择假设：

​          【原假设】A组和B组的点击率无显著变化即：$p_a=p_b$

​          【备择假设】A组和B组的点击率有显著变化 : $p_a\neq p_b$

原假设成立时，$p_a-p_b=0$。同时令$\frac{\bar X(1-\bar X)}{n}$来估计$X$ 的方差$\frac{p(1-p)}{n}$，就能得到统计量：
$$
\large Z = \frac{\bar X_a - \bar X_b}{\sqrt{\frac{\bar X_a(1-\bar X_a)}{n_a}+\frac{\ X_b(1-\bar X_b)}{n_b}}} 
\sim N(0,1)
$$
令$z_{\alpha}$是标准正态分布的概率分布值 ,$\alpha = 0.05$，当$|Z|>z_{1-\alpha/2}$时，说明__原假设__发生的概率为$\alpha$,我们以$1-\alpha$的概率拒绝原假设。即当$|Z|>z_{0.975}=1.96$时，我们有95%的把握接受备择假设，认为A组和B组的点击率有显著变化。



# 实例说明

我们回到开头的例子：

​        【点击率场景】最近模型团队新开发新模型模型，为了验证新模型效果，将人群随机分配进行AB测试，实验组A使用新模型，对照组B使用旧模型。观察了一段时间的结果后，得到如下观测结果：实验组A样本量10000人，点击量1000人；对照组B样本量10000人，点击量800人。是否能说明在提升点击率上新模型效果优于旧模型？

第一步，构建原假设和备择假设：

​        【原假设】$H_0： p_a = p_b$

​        【备择假设】$H_1： p_a \neq p_b$

第二步，构建统计量：
$$
\begin{eqnarray}    \label{eq}
\large Z &=& \frac{\bar X_a - \bar X_b}{\sqrt{\frac{\bar X_a(1-\bar X_a)}{n_a}+\frac{\ X_b(1-\bar X_b)}{n_b}}} \\
& =& \frac{0.1-0.08}{\sqrt{\frac{0.1*0.9}{10000}+\frac{0.08*0.92}{10000}}}\\
& =& 4.944 \\
\end{eqnarray}
$$
第三步，得出结论：

​        令$\alpha = 0.05$，由于$Z>z_{0.975} = 1.96$，所以拒绝原假设，接受备择假设，认为新模型的效果显著优化旧模型。



### 扩展到连续型随机变量

​        【观看时长场景】假设模型是用于提升用户观看时长的，验证新模型是否有效。

由于观看时长是连续型随机变量，可以假定服从正态分布。因此用$\sum_{i=1}^n\frac {(X_i -  \bar X)}{n}$来估计$X$的方差，统计量应该改写成。
$$
\large Z = \frac{\bar X_a - \bar X_b}
{\sqrt{\frac {\sum_{i=1}^{n_a}(X_a^i -  \bar X_a)}{n_a}+
\frac {\sum_{i=1}^{n_b}(X_b^i -  \bar X_b)}{n_b}}} 
\sim N(0,1)
$$


### 参考资料

[冠军/挑战者试验（A/B Test）](https://zhuanlan.zhihu.com/p/144924899)



